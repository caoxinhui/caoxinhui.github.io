---
title: å€’è®¡æ—¶
date: 2019-12-28 17:34:28
tags: é¡¹ç›®ç»å†
categories: é¡¹ç›®ç»å†
---

## æœ€è¿‘ç”¨ä¸¤ç§å†™å‘å†™äº†å€’è®¡æ—¶çš„åŠŸèƒ½

<!-- more -->


### ç¬¬ä¸€ç§ï¼Œé€šè¿‡requestAnimationFrameå®ç°
æˆ‘ä»¬ç”¨ Hooks æ¥å®ç°å€’è®¡æ—¶çš„åŠŸèƒ½ã€‚
æ‰¾åˆ°ä¸€ç¯‡ç›¸åŒçš„æ–‡ç« ï¼Œ[ç‚¹å‡»](https://css-tricks.com/using-requestanimationframe-with-react-hooks/)

åœ¨å‡½æ•°å¼ç»„ä»¶ä¸­ï¼Œæœ‰ä¸‰ç§æ–¹å¼å­˜å‚¨å˜é‡
- é€šè¿‡ let æˆ–è€… const å®šä¹‰ä¸€ä¸ªå˜é‡ï¼Œæ¯å½“ç»„ä»¶é‡æ–°æ¸²æŸ“çš„æ—¶å€™ï¼Œè¿™äº›å˜é‡éƒ½ä¼šé‡æ–°è¢«åˆå§‹åŒ–
- é€šè¿‡ useState ,åœ¨å¤šæ¬¡é‡æ–°æ¸²æŸ“ä¹‹åï¼Œå®ƒçš„å€¼ä¿æŒä¸å˜ã€‚å¹¶ä¸”ï¼Œå¦‚æœé€šè¿‡ setState æ”¹å˜äº†å®ƒçš„å€¼ï¼Œä¹Ÿä¼šå¼•èµ· é‡æ–°æ¸²æŸ“
- useRef

useRef æœ€å¼€å§‹ä½¿ç”¨ï¼Œæ˜¯æŒ‡å‘ DOM çš„ï¼Œä½†ä»–çš„ç”¨å¤„å¹¶ä¸ä»…ä»…å¦‚æ­¤ã€‚ä»–æ˜¯ä¸€ä¸ªå¯å˜çš„å¯¹è±¡ï¼Œå¹¶ä¸”åœ¨å¤šæ¬¡æ¸²æŸ“åè¿˜èƒ½ä¿æŒä»–çš„å€¼ä¸å˜ã€‚
useRef å®šä¹‰çš„å˜é‡ å’Œ useState å®šä¹‰çš„å˜é‡ç›¸ä¼¼ï¼Œé™¤äº†è¯»å–å’Œæ›´æ–°ä»–çš„å€¼é€šè¿‡ .current å±æ€§ï¼Œé™¤äº†æ”¹å˜ä»–çš„å€¼ä¸ä¼šè§¦å‘é‡æ–°æ¸²æŸ“

ğŸ‘‡å½“ Component ç»„ä»¶çš„çˆ¶ç»„ä»¶ä¸åœ render çš„æ—¶å€™ï¼ŒComponent ç»„ä»¶ä¹Ÿä¼šè·Ÿç€renderï¼Œä½†æ˜¯ variable çš„å€¼ä¿æŒä¸å˜ã€‚
å…¶ä¸­ setTimeout å‡½æ•°ä¼šæ‰§è¡Œï¼Œä½†æ˜¯ variable çš„å€¼å§‹ç»ˆä¿æŒ 5ã€‚
 
```jsx
function Component() {
  let variable = 5;

  setTimeout(() => {
    variable = variable + 3;
  }, 100)

  return <div>{variable}</div>
}
```

ğŸ‘‡ å½“ä½¿ç”¨ useState æ—¶ï¼Œå°±ç®—çˆ¶ç»„ä»¶ä¸é‡æ–°æ¸²æŸ“ï¼Œ variable çš„å€¼è¿˜æ˜¯ä¼šæ¯éš”ä¸€ç§’å¢åŠ  3
å› ä¸ºå½“é¡µé¢æ¸²æŸ“æ—¶ï¼ŒsetTimeout ä¼šåœ¨ä¸€ç§’å setVariableï¼Œè€Œ setVariable ä¼šè§¦å‘ç»„ä»¶æ¸²æŸ“ï¼Œè€Œç»„ä»¶æ¸²æŸ“åˆä¼šå¯¼è‡´ setTimeout ä¸€ç§’å setVariable
```jsx
function Component() {
    let [variable,setVariable] = useState(5)
    setTimeout(function () {
        setVariable(variable+3)
    },1000)
    return (
        <div>{variable}</div>
    )
}
```

 ğŸ‘‡ å½“ä½¿ç”¨ useRef ï¼Œç»„ä»¶ä¼šè¿”å› 5ï¼Œå¹¶ä¸”ä¸ä¼šè§¦å‘é‡æ–°æ¸²æŸ“ã€‚ä½†æ˜¯ï¼Œå¦‚æœçˆ¶ç»„ä»¶é‡æ–°æ¸²æŸ“ï¼Œä¼šå¼•èµ· variable æ¯æ¬¡å¢åŠ  3ã€‚
 âš ï¸ æ³¨æ„ï¼Œç¬¬ä¸€æ¬¡æ¸²æŸ“åï¼ŒsetTimeout æ‰§è¡Œ 1 ç§’ååŠ  3ï¼Œå¹¶ä¸ä¼šå¯¼è‡´ variable åŠ  3ï¼Œå› ä¸ºæ²¡æœ‰è§¦å‘é‡æ¸²æŸ“ã€‚
```jsx
function Component() {
    let variable = useRef(5)
    setTimeout(function () {
        variable.current += 3
    },1000)
    return (
        <div>{variable.current}</div>
    )
}
```

âœ… åœ¨è¿™é‡Œï¼Œæˆ‘ä»¬éœ€è¦ä½¿ç”¨ useRef çš„ä¸¤ä¸ªåœ°æ–¹
- request animation frame ID
- å‰ä¸€æ¬¡çš„ timestamp



#### useEffect
useEffect æ–¹æ³•åªæ‰§è¡Œä¸€æ¬¡ï¼Œå› æ­¤ï¼Œç»™ useEffect çš„ç¬¬äºŒä¸ªå‚æ•°ä¼ é€’ä¸€ä¸ªç©ºæ•°ç»„ã€‚
ä½†æ˜¯ï¼Œä¼ é€’ç©ºæ•°ç»„æœ‰ä¸€ä¸ªå‰¯ä½œç”¨ï¼Œåœ¨åŠ¨ç”»æœŸé—´ï¼Œæˆ‘ä»¬ä¸èƒ½è·å–åˆ°æ­£ç¡®çš„ state ä¿¡æ¯ã€‚
ç¬¬äºŒä¸ªå‚æ•°åº”è¯¥æ˜¯ä¸€ç³»åˆ—æ”¹å˜çš„å€¼ï¼Œè€Œå› ä¸ºè¿™äº›å€¼çš„æ”¹å˜ï¼Œç»„ä»¶éœ€è¦ä½œå‡ºç›¸åº”çš„æ”¹å˜ã€‚
å¦‚ä¾‹å­æ‰€ç¤ºï¼Œanimation ä¸­çš„ state å€¼ï¼Œå§‹ç»ˆæ˜¯åˆå§‹å€¼ï¼Œä¸ä¼šå› ä¸º setState è€Œå¯¼è‡´ animate ä¸­çš„å€¼å‘ç”Ÿå˜åŒ–ã€‚
```jsx
function App() {
  const [state, setState] = React.useState(0)
  const requestRef = React.useRef()
  const animate = time => {
    // The 'state' will always be the initial value here
    requestRef.current = requestAnimationFrame(animate);
  }
  React.useEffect(() => {
    requestRef.current = requestAnimationFrame(animate);
    return () => cancelAnimationFrame(requestRef.current);
  }, []); // Make sure the effect runs only once
  return <div>{state}</div>;
}
```
é‚£åœ¨ useEffect ä¸­æ€ä¹ˆè·å–æœ€æ–°çŠ¶æ€å‘¢ï¼Ÿ
ğŸ™Œé€šè¿‡ `setState(prevState => prevState + delta)`

å®ç°çš„åŠŸèƒ½æ˜¯ï¼šä» 1 æ•°åˆ° 100ï¼Œ ä¹‹åå›åˆ° 1 é‡æ–°å¼€å§‹è®¡æ•°
çœ‹çœ‹ä»£ç 

```js
const Counter = () => {
    const [count, setCount] = React.useState(0)
    const requestRef = React.useRef();
    const previousTimeRef = React.useRef();
    const animate = time => {
        if (previousTimeRef.current != undefined) {
            const deltaTime = time - previousTimeRef.current;
            setCount(prevCount => (prevCount + deltaTime * 0.01) % 100);
        }
        previousTimeRef.current = time;
        requestRef.current = requestAnimationFrame(animate);
    }
    React.useEffect(() => {
        requestRef.current = requestAnimationFrame(animate);
        return () => cancelAnimationFrame(requestRef.current);
    }, []); 

    return <div>{Math.round(count)}</div>
}
```
ğŸ‘ å°†ä¸»è¦é€»è¾‘è¿ç§»åˆ° è‡ªå®šä¹‰Hookã€‚
- ç®€åŒ–æˆ‘ä»¬çš„ç»„ä»¶ï¼Œéšè—å˜é‡ï¼Œä¸å¯¹ç»„ä»¶å½±å“
- è‡ªå®šä¹‰ç»„ä»¶å¯å¤ç”¨

ä½œä¸ºå…¬çº¦ï¼Œè‡ªå®šä¹‰ç»„ä»¶åº”è¯¥ä»¥ use å¼€å¤´ï¼Œå¹¶ä¸” hooks çš„è§„åˆ™é€‚ç”¨ã€‚


```jsx
const useAnimationFrame = callback => {
    const requestRef = React.useRef();
    const previousTimeRef = React.useRef();
    const animate = time => {
        if (previousTimeRef.current != undefined) {
            const deltaTime = time - previousTimeRef.current;
            callback(deltaTime)
        }
        previousTimeRef.current = time;
        requestRef.current = requestAnimationFrame(animate);
    }

    React.useEffect(() => {
        requestRef.current = requestAnimationFrame(animate);
        return () => cancelAnimationFrame(requestRef.current);
    }, []);
}

const Counter = () => {
    const [count, setCount] = React.useState(0)
    useAnimationFrame(deltaTime => {
        setCount(prevCount => (prevCount + deltaTime * 0.01) % 100)
    })
    return <div>{Math.round(count)}</div>
}
```



é€šè¿‡ `document.addEventListener("visibilitychange",this.diffTime,false)` è§¦å‘å¯è§†ç›‘å¬äº‹ä»¶ã€‚
ä½†æ˜¯ï¼Œé€šè¿‡æµè§ˆå™¨æ‰“å¼€çš„é¡µé¢ï¼Œæ¯”å¦‚å¾®ä¿¡æµè§ˆå™¨ï¼Œ `safari` æµè§ˆå™¨ï¼Œå…¶ä»–æ‰‹æœºè‡ªå¸¦æµè§ˆå™¨ç­‰ç­‰ï¼Œæ˜¯åœ¨å½“å‰é¡µé¢æ–°å¼€çš„ï¼Œæ‰€ä»¥ä¸ä¼šè§¦å‘ `visibilitychange` äº‹ä»¶ï¼Œç›¸å½“äºä¸€ç›´åœ¨å½“å‰é¡µé¢ï¼Œä»æ¥æ²¡æœ‰ç¦»å¼€è§†å£ã€‚è€Œä¸”æµè§ˆå™¨ä¼šå¯¹æ‰“å¼€çš„ä¹Ÿæ²¡è¿›è¡Œç¼“å­˜ï¼Œé¡µé¢å›é€€ä¸ä¼šé‡æ–°ä» `componentwillcreate` ç”Ÿå‘½å‘¨æœŸå¼€å§‹ï¼Œåªä¼šä» `componentdidmount` å¼€å§‹ï¼Œä¹Ÿå°±æ˜¯æœåŠ¡ç«¯ç”Ÿæˆçš„ `html` ä¸ä¼šé‡æ–°è¯·æ±‚ï¼Œåªä¼šå¯¹å®¢æˆ·ç«¯çš„æ“ä½œé‡æ–°å¼€å§‹æ‰§è¡Œã€‚
 è§£å†³æ–¹æ³•æ˜¯
 é™æ€ `html` ä¸­æ·»åŠ 

``` html
<input type="hidden" id="refreshed" value="no" />
```

`componentDidMount` ä¸­æ·»åŠ 
 

``` js
 disableHTMLCache = () => {
     if (typeof window !== "undefined") {
         window.onload = function() {
             let e = document.getElementById("refreshed");
             if (e.value == "no") {
                 e.value = "yes";
             } else {
                 e.value = "no";
                 location.reload();
             }
         };
     }
 };
```

[æµè§ˆå™¨ç‰¹æ€§æ”¯æŒ](https://developers.google.com/web/updates/2019/02/back-forward-cache)

#### ç¬¬äºŒç§ï¼Œé€šè¿‡setIntervalå®ç°

  + `JS` ä¸»çº¿ç¨‹æ‰§è¡Œæ—¶æœ‰ä¸€ä¸ªæ ˆå­˜å‚¨è¿è¡Œæ—¶çš„å‡½æ•°ç›¸å…³å˜é‡, é‡åˆ°å‡½æ•°æ—¶ä¼šå…ˆå…¥æ ˆæ‰§è¡Œå®Œåå†å‡ºæ ˆã€‚å½“é‡åˆ° `setTimeout`  `setInterval`  `requestAnimationFrame` ä»¥åŠ `I/O` æ“ä½œæ—¶ï¼Œè¿™äº›å‡½æ•°ä¼šç«‹åˆ»è¿”å›ä¸€ä¸ªå€¼ï¼ˆå¦‚ `setInterval` è¿”å›ä¸€ä¸ª `intervalID` ï¼‰ä¿è¯ä¸»çº¿ç¨‹ç»§ç»­æ‰§è¡Œï¼Œè€Œå¼‚æ­¥æ“ä½œåˆ™ç”±æµè§ˆå™¨çš„å…¶å®ƒçº¿ç¨‹ç»´æŠ¤ã€‚å½“å¼‚æ­¥æ“ä½œå®Œæˆæ—¶ï¼Œæµè§ˆå™¨ä¼šå°†å…¶å›è°ƒå‡½æ•°æ’å…¥ä¸»çº¿ç¨‹çš„ä»»åŠ¡é˜Ÿåˆ—ä¸­ï¼Œå½“ä¸»çº¿ç¨‹æ‰§è¡Œå®Œå½“å‰æ ˆçš„é€»è¾‘åï¼Œæ‰ä¼šä¾æ¬¡æ‰§è¡Œä»»åŠ¡é˜Ÿåˆ—ä¸­çš„ä»»åŠ¡ã€‚ 

  + ä½†æ˜¯åœ¨æ¯ä¸ªä»»åŠ¡ä¹‹é—´ï¼Œè¿˜æœ‰ä¸€ä¸ªå¾®ä»»åŠ¡é˜Ÿåˆ—çš„å­˜åœ¨ã€‚åœ¨å½“å‰ä»»åŠ¡æ‰§è¡Œå®Œåï¼Œå°†å…ˆæ‰§è¡Œå¾®ä»»åŠ¡é˜Ÿåˆ—ä¸­çš„æ‰€æœ‰ä»»åŠ¡ï¼Œä¾‹å¦‚ `Promise`  `process.nextTick` ç­‰æ“ä½œã€‚ä¹Ÿå°±æ˜¯è¯´å½“ `setInterval(fn, 1000)` ç­‰å¾… `1` ç§’é’Ÿåï¼Œ `fn` å‡½æ•°ä¼šè¢«æ’å…¥ä»»åŠ¡é˜Ÿåˆ—ä¸­ï¼Œä½†å¹¶ä¸ä¸€å®šä¼šç«‹åˆ»æ‰§è¡Œï¼Œè¿˜éœ€è¦ç­‰å¾…å½“å‰ä»»åŠ¡ä»¥åŠå¾®ä»»åŠ¡é˜Ÿåˆ—ä¸­çš„æ‰€æœ‰ä»»åŠ¡æ‰§è¡Œå®Œã€‚é•¿æ­¤ä»¥å¾€ï¼Œä½¿ç”¨ `setInterval` çš„è®¡æ—¶å™¨è¶…æ—¶å°†è¶Šæ¥è¶Šä¸¥é‡ã€‚

```js
console.log('console.log()')
setTimeout(function() {
    console.log('setTimeOut')
})
Promise.resolve().then(function() {
    console.log('promise1')
}).then(function() {
    console.log('promise2')
})
console.log('script end')
```

```js
 let [milliSecs, setmilliSecs] = useState(remainingTime);

 const startCountDown = async () => {
     milliSecs -= 1000;
     setmilliSecs(milliSecs);
     if (milliSecs <= 0) {
         clearInterval(timer);
         await updateInitialData();
     }
 };

 useEffect(() => {
     timer = setInterval(startCountDown, 1000);
     return () => {
         clearInterval(timer);
     };
 }, []);
```
