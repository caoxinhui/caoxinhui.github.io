---
title: 设计模式
date: 2020-02-07 16:18:53
tags:
---

## JavaScript模式

### 单例模式（Singleton）
要求

``` js
var uni = new Universe()
var uni2 = new Universe()
uni === uni2
```

实现
**静态属性中的实例**

``` js
function Universe() {
    if (typeof Universe.instance === "object") {
        return Universe.instance
    }
    this.start_time = 0
    this.bang = "Big"
    Universe.instance = this
    // 隐藏返回
    return this
}
```

缺点：instance属性是公开的。

**闭包中的实例**

``` js
function Universe() {
    var instance;
    Universe = function Universe() {
        return instance
    }
    Universe.prototype = this
    instance = new Universe()
    instance.constructor = Universe
    instance.start_time = 0
    instance.bang = "Big"
    return instance
}
```

**构造函数和实例包装在即时函数中**

``` js
var Universe(function() {
    var instance
    Universe = function Universe() {
        if (instance) {
            return instance
        }
        instance = this
        this.start_time = 0
        this.bang = "Big"
    }
})
```

### 工厂模式

``` js
function CarMaker() {}
CarMaker.prototype.drive = function() {
    return "Vroom, I have " + this.doors + " doors"
}
CarMaker.factory = function(type) {
    var constr = type,
        newcar;
    if (typeof CarMaker[constr] !== "function") {
        throw {
            name: "Error",
            message: constr + " doesn't exist"
        }
    }
    if (typeof CarMaker[constr].prototype.drive !== "function") {
        CarMaker[constr].prototype = new CarMaker()
    }
    newcar = new CarMaker[constr]()
    return newcar
}
CarMaker.Compact = function() {
    this.doors = 4
}
CarMaker.Convertible = function() {
    this.doors = 2
}
CarMaker.SUV = function() {
    this.doors = 24
}

var corolla = CarMaker.factory('Compact')
var solstice = CarMaker.factory('Convertible')
var cherokee = CarMaker.factory('SUV')
corolla.drive()
solstice.drive()
cherokee.drive()
```

### 迭代器模式

``` js
var agg = (function() {
    var index = 0,
        data = [1, 2, 3, 4, 5],
        length = data.length;
    return {
        next: function() {
            var element;
            if (!this.hasNext()) {
                return null
            }
            element = data[index]
            index = index + 2
            return element
        },
        hasNext: function() {
            return index < length
        }
    }
}())
```

### 装饰者模式
> 实现装饰者模式的其中一种方法是使得每个装饰则成为一个对象，并且该对象包含了应该被重载的方法。
```js
var sale = new Sale(100)
sale = sale.decorate('fedtax')
sale = sale.decorate('quebec')
sale = sale.decorate('money')
sale.getPrice()

function Sale(price) {
  this.price = price || 100
}
Sale.prototype.getPrice = function () {
  return this.price
}
Sale.decorators = {}

Sale.decorators.fedtax = {
  getPrice: function () {
    var price = this.uber.getPrice()
    price += price * 5 / 100
    return price
  }
}
Sale.decorators.quebec = {
  getPrice: function () {
    var price = this.uber.getPrice()
    price += price * 7.5 / 100
    return price
  }
}


Sale.decorators.money = {
  getPrice: function () {
    return "$" + this.uber.getPrice().toFixed(2)
  }
}
Sale.decorators.cdn = {
  getPrice: function () {
    return "CDN$ " + this.uber.getPrice().toFixed(2)
  }
}

Sale.prototype.decorate = function (decorator) {
  var F = function () { },
    overrides = this.constructor.decorators[decorator],
    i, newobj
  F.prototype = this
  newobj = new F()
  newobj.uber = F.prototype
  for (i in overrides) {
    if (overrides.hasOwnProperty(i)) {
      newobj[i] = overrides[i]
    }
  }
  return newobj
}
```

使用列表实现
```js
var sale = new Sale(100)
sale.decorate('fedtax')
sale.decorate('quebec')
sale.decorate('money')
sale.getPrice()

function Sale(price) {
  this.price = (price > 0) || 100
  this.decorators_list = []
}
Sale.decorators = {}

Sale.decorators.fedtax = {
  getPrice: function (pirce) {
    return price + price * 5 / 100
  }
}
Sale.decorators.quebec = {
  getPrice: function (price) {
    return price + price * 7.5 / 100
  }
}

Sale.decorators.money = {
  getPrice: function (price) {
    return "$" + price.toFixed(2)
  }
}
Sale.decorators.cdn = {
  getPrice: function (price) {
    return "CDN$ " + price.toFixed(2)
  }
}

Sale.prototype.decorate = function (decorator) {
  this.decorators_list.push(decorator)
}
Sale.prototype.getPrice = function () {
  var price = this.price,
    i, max = this.decorators_list.length,
    name;
  for (i = 0; i < max; i += 1) {
    name = this.decorators_list[i]
    price = Sale.decorators[name].getPrice(price)
  }
  return price
}
```
### 策略模式
```js
varlidator.config = {
  first_name: 'isNonEmpty',
  age: 'isNumber',
  username: 'isAlphaNum'
}
varlidator.validate(data)
if (varlidator.hasErrors()) {
  console.log(varlidator.messages.join('\n'))
}

varlidator.types.inNonEmpty = {
  validate: function (value) {
    return value !== ""
  },
  instructions: "the value cannot be empty"
}
varlidator.types.isNumber = {
  validate: function (value) {
    return !isNaN(value)
  },
  instructions: "the value can only be a valid number"
}
varlidator.types.isAlphaNum = {
  validate: function (value) {
    return !/[^a-z0-9]/i.test(value)
  },
  instructions: "the value can only contain characters and numbers,no special symbols"
}

var varlidator = {
  types: {},
  messages: [],
  config: {},
  validate: function (data) {
    var i, msg, type, checker, result_ok
    this.messages = []
    for (i in data) {
      if (data.hasOwnProperty(i)) {
        type = this.config[i]
        checker = this.types[type]
        if (!type) {
          continue
        }
        if (!checker) {
          throw {
            name: "ValidationError",
            message: "No handler to validate type " + type
          }
        }
        result_ok = checker.validate(data[i])
        if (!result_ok) {
          msg = "Invalid value for " + i + "*, " + checker.instructions
          this.messages.push(msg)
        }
      }
    }
    return this.hasErrors()
  },
  hasErrors: function () {
    return this.messages.length !== 0
  }
}

```